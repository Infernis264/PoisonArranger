<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
<title>Poison Arranger</title>
<style>
	html, body {
		overflow: hidden;
	}
	td {
		width: 100px;
		height: 100px;
		border: 1px solid black;
	}
	#next {
		width: 100px;
		height: 100px;
	}
	td, #next {
		background-repeat: no-repeat;
		background-size: 100px 100px;
	}
	body {
		display: flex;
		flex-direction: row;
	}
</style>
</head>
<body>
<h1>poison arranger!!</h1><br/>
<table><tbody>
	<tr data-row="0">
		<td data-col="0"></td>
		<td data-col="1"></td>
		<td data-col="2"></td>
		<td data-col="3"></td>
		<td data-col="4"></td>
	</tr>
	<tr data-row="1">
		<td data-col="0"></td>
		<td data-col="1"></td>
		<td data-col="2"></td>
		<td data-col="3"></td>
		<td data-col="4"></td>
	</tr>
	<tr data-row="2">
		<td data-col="0"></td>
		<td data-col="1"></td>
		<td data-col="2"></td>
		<td data-col="3"></td>
		<td data-col="4"></td>
	</tr>
	<tr data-row="3">
		<td data-col="0"></td>
		<td data-col="1"></td>
		<td data-col="2"></td>
		<td data-col="3"></td>
		<td data-col="4"></td>
	</tr>
	<tr data-row="4">
		<td data-col="0"></td>
		<td data-col="1"></td>
		<td data-col="2"></td>
		<td data-col="3"></td>
		<td data-col="4"></td>
	</tr>
</tbody></table>
<span>
	next up!
	<div id="next"></div>
	<span>Score: <span id="score"></span></span>
</span>
<script>

function weightedArraySelect(arr, numItems) {
    const weights = Array.from({ length: arr.length }, (_, index) => 1 / (index + 1)); // Inverse 1/x shape weights
    const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
    const selectedItems = [];

    for (let i = 0; i < numItems; i++) {
        let randomValue = Math.random() * totalWeight;
        for (let j = 0; j < arr.length; j++) {
            randomValue -= weights[j];
            if (randomValue <= 0) {
                selectedItems.push(arr[j]);
                break;
            }
        }
    }

    return selectedItems;
}
const poisons = ["", "wut.png", "asmr.png", "telepack.png", "crust.png", "long.png", "pog.png", "seemsgood.png", "notlikethis.png", "squish.png", "poisonmec.png", "auauaua.png"]
const weights = [ 40, 18, 14, 7, 5, 5, 4, 3, 2, 1, 1 ];

const totalRate = weights.reduce((sum, rate) => sum + rate, 0);

// Generate a weighted random index
function getRandomWeightedIndex() {
  const randomValue = Math.random() * totalRate;
  let sum = 0;
  for (let i = 0; i < weights.length; i++) {
    sum += weights[i];
    if (randomValue <= sum) {
      return i;
    }
  }
}


let score = 0;

let grid = [...Array(5)].map(e => (new Array(5)).fill(0));
let nextup = 1+getRandomWeightedIndex();//Math.floor(Math.random() * (poisons.length - 1)) + 1;
document.getElementById("next").setAttribute("style", "background-image: "+`url("./img/${poisons[nextup]}");`);

document.addEventListener("click", e => {
	if (e?.target?.tagName?.toLowerCase() === "td") {
		let [row, col] = [e.target.parentElement.dataset.row, e.target.dataset.col];

		if (grid[row][col] !== 0) return;

		grid[row][col] = nextup;

		updateBoard(row, col);

		boardToImg();

		nextup = 1+getRandomWeightedIndex();//Math.floor(Math.random() * (poisons.length - 1)) + 1;

		document.getElementById("next").setAttribute("style", "background-image: "+`url("./img/${poisons[nextup]}");`);

		document.getElementById("score").textContent = score;
	}
});
function boardToImg() {
	let tdeez = Array.from(document.querySelectorAll("td"));
	for (let td of tdeez) {
		let row = td.parentElement.dataset.row;
		let col = td.dataset.col;
		let img = poisons[grid[row][col]];
		if (img === "") {
			td.setAttribute("style", "background-image: unset;");
		} else {
			td.setAttribute("style", "background-image: "+`url("./img/${img}");`);
		}
	}
}

function updateBoard(row, col) {
	let startCol = parseInt(col);
	let endCol = parseInt(col);
	let startRow = parseInt(row);
	let endRow = parseInt(row);
	let matchCell = grid[row][col];

	while (startCol > 0) {
		if (grid[row][startCol - 1] === matchCell) {
			startCol--;
		} else {
			break;
		}
	}
	while (endCol < grid[0].length - 1) {
		if (grid[row][endCol + 1] === matchCell) {
			endCol++;
		} else {
			break;
		}
	}
	let matchCount = endCol - startCol + 1;
	if (matchCount >= 3) {
		for (let i = startCol; i <= endCol; i++) {
			grid[row][i] = 0;
		}
		grid[row][col] = matchCell + 1;
		score+=matchCount*400;
		return;
	}
	while (startRow > 0) {
		if (grid[startRow - 1][col] === matchCell) {
			startRow--;
		} else {
			break;
		}
	}
	while (endRow < grid.length - 1) {
		if (grid[endRow + 1][col] === matchCell) {
			endRow++;
		} else {
			break;
		}
	}
	matchCount = endRow - startRow + 1;
	if (matchCount >= 3) {
		for (let i = startRow; i <= endRow; i++) {
			grid[i][col] = 0;
		}
		grid[row][col] = matchCell + 1;
		score+=matchCount*400;
		return;
	}
}

</script>
</body>
</html>
